<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

    <bean class="org.dspace.xmlworkflow.XmlWorkflowFactoryImpl">
        <property name="workflowMapping">
            <util:map>
                <entry key="defaultWorkflow"
                       value-ref="defaultWorkflow"/>
<!--                <entry key="123456789/4" value-ref="selectSingleReviewer"/>-->
<!--                <entry key="123456789/5" value-ref="scoreReview"/>-->
                <entry key="10915/50" value-ref="autoarchive"/>
                <entry key="10915/28975" value-ref="autoarchive"/>
            </util:map>
        </property>
    </bean>

        <!--Workflow modificado para SeDiCI-->
        <!--
        Roles:
        - CollectionAdmin: revisores a nivel de coleccion/comunidad (ej.: bibliotecarios) a quienes se delega
                        una primera revisión y corrección de los documentos enviados.
        - SeDiCIAdmin: revisores para todas las colecciones. Se corresponde con un Group en la aplicación,
                         cuyos miembros son responsables de la revisión y aceptación final de cada
                         documento (haya pasado o no por la revisión del CollectionAdmin)

        Pasos de revisión:
        - (Paso 1) CollectionLevelReview: ejecutable por el rol CommAdmin. Su ejecución se
                           determina a nivel de las Community padre de la Collection vinculada al workflow,
                           creando el grupo COMMUNITY_X_ADMIN (desde la administración de la Comunidad X, padre de
                           la coleccion vinculada al workflow) y asignando usuarios al mismo. Si este grupo
                           no existe o no posee usuarios, este paso del workflow se omite y el recurso pasa
                           directamente al siguiente paso.
        - (Paso 2) SeDiCILevelReview: ejecutable por el rol SeDiCIAdmin. La intención es que siempre se ejecute este paso,
                           obligando así a revisar todos los recursos enviados.

        Si bien los pasos son ejecutados por roles distintos, la acción de cada uno es la misma: Editar/Aceptar/Rechazar.
        Esto es para que tanto a nivel local (colección) como a nivel global (administradores de SeDiCI) exista la posibilidad de
        editar los metadatos de un envío, rechazarlo o bien aceptarlo (para pasar al paso 2 o archivarlo en DSpace según corresponda).


        Coleccion de Autoarchivo:

        Para la coleccion de autoarchivo se utiliza un workflow especial que incluye una Action adicional para la seleccion de la
        colección en la que se instalará el ítem.
     -->


    <!--Standard DSpace workflow-->
    <bean name="defaultWorkflow" class="org.dspace.xmlworkflow.state.Workflow">
        <property name="firstStep" ref="CollectionLevelReview"/>
        <property name="steps">
            <util:list>
                <!-- PASO 1: Revisión a nivel de colección (aplicable por colección) -->
                <ref bean="CollectionLevelReview"/>
                <!-- PASO 2: Revisión a nivel de SeDiCI (aplicable a todos los ítems de todo el repositorio) -->
                <ref bean="SeDiCILevelReview"/>
            </util:list>
        </property>
    </bean>

    <!-- Workflow para la coleccion de autoarchivo -->
    <bean name="autoarchive" class="org.dspace.xmlworkflow.state.Workflow">
        <property name="firstStep" ref="SeDiCILevelReviewAutoarchive_editstep"/>
        <property name="steps">
            <util:list>
                <!-- PASO 1: Revisión a nivel de SeDiCI (aplicable a todos los ítems de todo el repositorio) -->
                <ref bean="SeDiCILevelReviewAutoarchive_editstep"/>
                <ref bean="SeDiCILevelReviewAutoarchive_selectcollectionstep"/>
            </util:list>
        </property>
    </bean>

    <bean name="CollectionLevelReview" class="org.dspace.xmlworkflow.state.Step">
        <property name="userSelectionMethod" ref="acceptRoleOrNotAdmin"/>
        <property name="role" ref="CommAdminRole"/>
        <property name="outcomes">
            <util:map>
                <entry key="#{ T(org.dspace.xmlworkflow.state.actions.ActionResult).OUTCOME_COMPLETE}"
                       value-ref="SeDiCILevelReview"/>
            </util:map>
        </property>
        <property name="actions">
            <util:list>
                <ref bean="editaction"/>
            </util:list>
        </property>
    </bean>

    <bean name="SeDiCILevelReview" class="org.dspace.xmlworkflow.state.Step">
        <property name="userSelectionMethod" ref="claimaction"/>
        <property name="role" ref="sediciAdminRole"/>
        <property name="actions">
            <util:list>
                <ref bean="editaction"/>
            </util:list>
        </property>
    </bean>

    <bean name="SeDiCILevelReviewAutoarchive_editstep" class="org.dspace.xmlworkflow.state.Step">
        <property name="userSelectionMethod" ref="claimaction"/>
        <property name="role" ref="sediciAdminRole"/>
        <property name="outcomes">
            <util:map>
                <entry key="#{ T(org.dspace.xmlworkflow.state.actions.ActionResult).OUTCOME_COMPLETE}"
                       value-ref="SeDiCILevelReviewAutoarchive_selectcollectionstep"/>
            </util:map>
        </property>
        <property name="actions">
            <util:list>
                <ref bean="editaction"/>
            </util:list>
        </property>
    </bean>

    <bean name="SeDiCILevelReviewAutoarchive_selectcollectionstep" class="org.dspace.xmlworkflow.state.Step">
        <property name="userSelectionMethod" ref="claimaction"/>
        <property name="role" ref="sediciAdminRole" />
        <property name="actions">
            <list>
                <ref bean="selectcollectionaction"/>
            </list>
        </property>
    </bean>

    <bean id="sediciAdminRole" class="org.dspace.xmlworkflow.Role">
        <property name="scope" value="#{ T(org.dspace.xmlworkflow.Role.Scope).REPOSITORY}"/>
        <property name="name" value="SeDiCIAdmin"/>
    </bean>

    <bean id="CommAdminRole" class="org.dspace.xmlworkflow.Role">
        <property name="scope" value="#{ T(org.dspace.xmlworkflow.Role.Scope).COMMUNITY}"/>
        <property name="name" value="commadmin"/>
    </bean>
</beans>